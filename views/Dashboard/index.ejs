<%- include('partials/header') %>
<link rel="stylesheet" href="/css/dashboard/dashboard.css">
</head>
<body>
  <div class="dash-wrapper">
    <%- include('partials/sidebar', { activePage: 'dashboard', user: user, stats: stats }) %>
    
    <main class="dash-main">
      <%- include('partials/topbar', { pageTitle: 'Dashboard', notifications: notifications, website: website }) %>
      
      <div class="dash-content">
        <!-- Hero Banner -->
        <div class="dashboard-hero">
          <div class="hero-content">
            <div class="hero-text">
              <h2>Welcome back, <%= user.name.split(' ')[0] %>!</h2>
              <p>Here's what's happening with your auto parts store today</p>
            </div>
            <div class="hero-stats">
              <div class="hero-stat-box">
                <div class="hero-stat-value"><%= stats.totalOrders.toLocaleString() %></div>
                <div class="hero-stat-label">Total Orders</div>
              </div>
              <div class="hero-stat-box">
                <div class="hero-stat-value">$<%= (stats.totalRevenue / 1000).toFixed(1) %>K</div>
                <div class="hero-stat-label">Revenue</div>
              </div>
              <div class="hero-stat-box">
                <div class="hero-stat-value"><%= stats.totalVisitors.toLocaleString() %></div>
                <div class="hero-stat-label">Visitors</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Website Status Card -->
        <div class="website-status-card">
          <div class="website-status-icon <%= website.status === 'online' ? '' : 'offline' %>">
            <i data-lucide="<%= website.status === 'online' ? 'check-circle' : 'alert-circle' %>"></i>
          </div>
          <div class="website-status-content">
            <div class="website-status-title"><%= website.name %></div>
            <div class="website-status-url">
              <a href="<%= website.url %>" target="_blank"><%= website.url %></a>
            </div>
          </div>
          <span class="website-status-badge <%= website.status === 'online' ? '' : 'offline' %>">
            <i data-lucide="<%= website.status === 'online' ? 'wifi' : 'wifi-off' %>"></i>
            <%= website.status === 'online' ? 'Online' : 'Offline' %>
          </span>
          <div class="website-status-actions">
            <a href="<%= website.url %>" target="_blank" class="dash-btn dash-btn-secondary dash-btn-sm">
              <i data-lucide="external-link"></i>
              Visit Site
            </a>
            <a href="/dashboard/appearance" class="dash-btn dash-btn-primary dash-btn-sm">
              <i data-lucide="palette"></i>
              Customize
            </a>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-icon">
              <i data-lucide="shopping-cart"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value"><%= stats.totalOrders %></div>
              <div class="stat-label">Total Orders</div>
              <div class="stat-change positive">
                <i data-lucide="trending-up"></i>
                +<%= stats.ordersGrowth %>%
              </div>
            </div>
          </div>
          <div class="stat-card green">
            <div class="stat-icon">
              <i data-lucide="dollar-sign"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">$<%= stats.totalRevenue.toLocaleString() %></div>
              <div class="stat-label">Total Revenue</div>
              <div class="stat-change positive">
                <i data-lucide="trending-up"></i>
                +<%= stats.revenueGrowth %>%
              </div>
            </div>
          </div>
          <div class="stat-card purple">
            <div class="stat-icon">
              <i data-lucide="users"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value"><%= stats.totalVisitors.toLocaleString() %></div>
              <div class="stat-label">Visitors</div>
              <div class="stat-change positive">
                <i data-lucide="trending-up"></i>
                +<%= stats.visitorsGrowth %>%
              </div>
            </div>
          </div>
          <div class="stat-card orange">
            <div class="stat-icon">
              <i data-lucide="percent"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value"><%= stats.conversionRate %>%</div>
              <div class="stat-label">Conversion Rate</div>
              <div class="stat-change <%= stats.conversionGrowth >= 0 ? 'positive' : 'negative' %>">
                <i data-lucide="<%= stats.conversionGrowth >= 0 ? 'trending-up' : 'trending-down' %>"></i>
                <%= stats.conversionGrowth >= 0 ? '+' : '' %><%= stats.conversionGrowth %>%
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
          <!-- Revenue Chart -->
          <div class="chart-card">
            <div class="chart-card-header">
              <h3 class="chart-card-title">
                <i data-lucide="trending-up"></i>
                Revenue Overview
              </h3>
              <div class="chart-card-actions">
                <button class="chart-filter-btn active" data-range="7d">7D</button>
                <button class="chart-filter-btn" data-range="30d">30D</button>
                <button class="chart-filter-btn" data-range="90d">90D</button>
              </div>
            </div>
            <div class="chart-card-body">
              <div class="chart-container">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Orders by Status Chart -->
          <div class="chart-card">
            <div class="chart-card-header">
              <h3 class="chart-card-title">
                <i data-lucide="pie-chart"></i>
                Orders by Status
              </h3>
            </div>
            <div class="chart-card-body">
              <div class="chart-container">
                <canvas id="ordersStatusChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-grid">
          <a href="/dashboard/orders" class="quick-action-card">
            <div class="quick-action-icon">
              <i data-lucide="shopping-cart"></i>
            </div>
            <div class="quick-action-title">View Orders</div>
            <div class="quick-action-desc"><%= stats.pendingOrders %> pending</div>
          </a>
          <a href="/dashboard/products" class="quick-action-card">
            <div class="quick-action-icon">
              <i data-lucide="package"></i>
            </div>
            <div class="quick-action-title">Add Product</div>
            <div class="quick-action-desc"><%= stats.totalProducts %> products</div>
          </a>
          <a href="/dashboard/appearance" class="quick-action-card">
            <div class="quick-action-icon">
              <i data-lucide="palette"></i>
            </div>
            <div class="quick-action-title">Customize Store</div>
            <div class="quick-action-desc">Edit appearance</div>
          </a>
          <a href="/dashboard/analytics" class="quick-action-card">
            <div class="quick-action-icon">
              <i data-lucide="bar-chart-3"></i>
            </div>
            <div class="quick-action-title">View Analytics</div>
            <div class="quick-action-desc">Detailed reports</div>
          </a>
        </div>

        <!-- Recent Orders Table -->
        <div class="orders-table-card">
          <div class="orders-table-header">
            <h3>
              Recent Orders
              <span class="orders-count"><%= orders.length %></span>
            </h3>
            <a href="/dashboard/orders" class="dash-btn dash-btn-secondary dash-btn-sm">
              View All
              <i data-lucide="arrow-right"></i>
            </a>
          </div>
          
          <% if (orders.length === 0) { %>
          <div style="padding: 3rem; text-align: center; color: var(--dash-text-muted);">
            <i data-lucide="package" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>No orders yet. They will appear here once customers start ordering.</p>
          </div>
          <% } else { %>
          <table class="orders-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% orders.slice(0, 5).forEach(function(order) { %>
              <tr>
                <td class="order-id"><a href="/dashboard/orders/<%= order.id %>">#<%= order.id %></a></td>
                <td>
                  <div class="customer-info">
                    <span class="customer-name"><%= order.customer %></span>
                    <span class="customer-email"><%= order.email %></span>
                  </div>
                </td>
                <td><%= order.date %></td>
                <td class="order-amount">$<%= order.amount.toLocaleString() %></td>
                <td>
                  <span class="order-status <%= order.status %>">
                    <i data-lucide="<%= order.status === 'delivered' ? 'check-circle' : order.status === 'shipped' ? 'truck' : order.status === 'processing' ? 'loader' : 'clock' %>"></i>
                    <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
                  </span>
                </td>
                <td>
                  <div class="order-actions">
                    <a href="/dashboard/orders/<%= order.id %>" class="order-action-btn" title="View">
                      <i data-lucide="eye"></i>
                    </a>
                  </div>
                </td>
              </tr>
              <% }); %>
            </tbody>
          </table>
          <% } %>
        </div>

        <!-- Two Column Grid: Activity Feed + Top Products -->
        <div class="charts-grid">
          <!-- Activity Feed -->
          <div class="activity-feed">
            <div class="chart-card-header">
              <h3 class="chart-card-title">
                <i data-lucide="activity"></i>
                Recent Activity
              </h3>
            </div>
            <% if (activities && activities.length > 0) { %>
              <% activities.forEach(function(activity) { %>
              <div class="activity-item">
                <div class="activity-icon <%= activity.type %>">
                  <i data-lucide="<%= activity.type === 'order' ? 'shopping-cart' : activity.type === 'visitor' ? 'user' : 'dollar-sign' %>"></i>
                </div>
                <div class="activity-content">
                  <div class="activity-text"><%= activity.message %></div>
                  <div class="activity-time"><%= activity.time %></div>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="activity-item">
                <div class="activity-content">
                  <div class="activity-text" style="color: var(--dash-text-muted);">No recent activity</div>
                </div>
              </div>
            <% } %>
          </div>

          <!-- Top Products -->
          <div class="chart-card">
            <div class="chart-card-header">
              <h3 class="chart-card-title">
                <i data-lucide="package"></i>
                Top Products
              </h3>
            </div>
            <div class="chart-card-body">
              <div class="chart-container">
                <canvas id="topProductsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

<%- include('partials/footer') %>

<script>
  // Revenue Chart
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [{
        label: 'Revenue',
        data: [<%= chartData.revenue.join(',') %>],
        borderColor: '#6366F1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#6366F1',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.05)' },
          ticks: {
            callback: function(value) { return '$' + value; }
          }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });

  // Orders Status Chart
  const ordersStatusCtx = document.getElementById('ordersStatusChart').getContext('2d');
  new Chart(ordersStatusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Pending', 'Processing', 'Shipped', 'Delivered'],
      datasets: [{
        data: [<%= chartData.orderStatus.join(',') %>],
        backgroundColor: ['#F59E0B', '#06B6D4', '#6366F1', '#10B981'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { padding: 20 }
        }
      },
      cutout: '60%'
    }
  });

  // Top Products Chart
  const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
  new Chart(topProductsCtx, {
    type: 'bar',
    data: {
      labels: [<%= chartData.topProducts.labels.map(l => "'" + l + "'").join(',') %>],
      datasets: [{
        label: 'Sales',
        data: [<%= chartData.topProducts.data.join(',') %>],
        backgroundColor: ['#6366F1', '#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE'],
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        y: {
          grid: { display: false }
        }
      }
    }
  });
</script>
